# è©•ä¾¡æ›´æ–°ã®å•é¡Œã¨è§£æ±ºæ–¹æ³•

## ğŸ” ç¢ºèªã•ã‚ŒãŸçŠ¶æ³

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å­˜åœ¨
- âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå­˜åœ¨: `sU6mNJw9ECRa4cH5eRXR`
- âœ… `parkId`: `NR3aSxwvZyHnNZOtZ2PR`ï¼ˆå‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®å…¬åœ’ï¼‰
- âœ… `rating`: `4`
- âœ… `createdAt`: 2025å¹´12æœˆ7æ—¥

### å…¬åœ’ã®è©•ä¾¡
- âŒ `rating: 0`ï¼ˆæ›´æ–°ã•ã‚Œã¦ã„ãªã„ï¼‰
- âŒ `reviewCount: 0`ï¼ˆæ›´æ–°ã•ã‚Œã¦ã„ãªã„ï¼‰

**å•é¡Œ**: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å­˜åœ¨ã™ã‚‹ã®ã«ã€å…¬åœ’ã®è©•ä¾¡ãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

---

## ğŸ”§ è§£æ±ºæ–¹æ³•

### æ–¹æ³•1: Firebase Consoleã§æ‰‹å‹•æ›´æ–°ï¼ˆå³åº§ã«è§£æ±ºï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: è©•ä¾¡ã‚’è¨ˆç®—
- ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: `1ä»¶`
- å¹³å‡è©•ä¾¡: `4.0`ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒ1ä»¶ã§`rating: 4`ã®å ´åˆï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—2: å…¬åœ’ã®è©•ä¾¡ã‚’æ›´æ–°
1. Firebase Console > Firestore Database > `parks`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ `NR3aSxwvZyHnNZOtZ2PR` ã‚’é¸æŠ
3. `rating`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†:
   - ç¾åœ¨ã®å€¤: `0`
   - æ–°ã—ã„å€¤: `4`ï¼ˆæ•°å€¤å‹ï¼‰
4. `reviewCount`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†:
   - ç¾åœ¨ã®å€¤: `0`
   - æ–°ã—ã„å€¤: `1`ï¼ˆæ•°å€¤å‹ï¼‰
5. ã€Œæ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### çµæœ
- HOMEç”»é¢ã«è©•ä¾¡ãŒåæ˜ ã•ã‚Œã¾ã™
- `4.0 (1ä»¶)` ã¨è¡¨ç¤ºã•ã‚Œã¾ã™

---

### æ–¹æ³•2: ã‚³ãƒ¼ãƒ‰ã®å•é¡Œã‚’ç¢ºèªï¼ˆæ ¹æœ¬çš„ãªè§£æ±ºï¼‰

#### ç¢ºèªãƒã‚¤ãƒ³ãƒˆ

1. **`updateParkRating`ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã‹**
   - `AddReviewScreen.js`ã®`handleSubmit`é–¢æ•°ã‚’ç¢ºèª
   - `await updateParkRating(parkId);`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹

2. **ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹**
   - é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
   - `updateParkRating`å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§

3. **Firestoreãƒ«ãƒ¼ãƒ«ã§è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹**
   - `parks`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`update`ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
   - èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ`rating`ã¨`reviewCount`ã‚’æ›´æ–°ã§ãã‚‹ã‹

#### ç¢ºèªæ–¹æ³•

##### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
1. ã‚¢ãƒ—ãƒªã‚’é–‹ã
2. é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ãï¼ˆExpo Goã®å ´åˆã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ç¢ºèªï¼‰
3. ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿
4. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

##### ã‚¹ãƒ†ãƒƒãƒ—2: Firestoreãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ«ã§ã¯ã€èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ`rating`ã¨`reviewCount`ã‚’æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š

```javascript
// Case 1: Only rating and reviewCount are being updated (by any authenticated user)
allow update: if isAuthenticated()
  && (
    (request.resource.data.rating is number
      && request.resource.data.rating >= 0
      && request.resource.data.rating <= 5
      && request.resource.data.reviewCount is number
      && request.resource.data.reviewCount >= 0
      && request.resource.data.userId == resource.data.userId
      && request.resource.data.name == resource.data.name
      && request.resource.data.address == resource.data.address
      && request.resource.data.createdAt == resource.data.createdAt)
    || ...
  );
```

ã“ã®ãƒ«ãƒ¼ãƒ«ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

##### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
`AddReviewScreen.js`ã®`handleSubmit`é–¢æ•°ã§ã€`updateParkRating`ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼š

```javascript
// Firestoreã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¿å­˜
await addDoc(collection(db, 'reviews'), {
  // ...
});

// å…¬åœ’ã®è©•ä¾¡ã‚’æ›´æ–°
await updateParkRating(parkId);
```

---

## ğŸ› è€ƒãˆã‚‰ã‚Œã‚‹åŸå› 

### åŸå› 1: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ãŒã€ã‚­ãƒ£ãƒƒãƒã•ã‚Œã¦ã„ã‚‹
- `updateParkRating`å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- `catch`ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œã€ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã ã‘
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ä¿å­˜ã•ã‚Œã‚‹ãŒã€è©•ä¾¡ã¯æ›´æ–°ã•ã‚Œãªã„

### åŸå› 2: éåŒæœŸå‡¦ç†ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ
- `addDoc`ã¨`updateParkRating`ã®å®Ÿè¡Œé †åº
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é…å»¶

### åŸå› 3: Firestoreãƒ«ãƒ¼ãƒ«ã®å•é¡Œ
- ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„
- ãƒ«ãƒ¼ãƒ«ã®æ¡ä»¶ãŒå³ã—ã™ãã‚‹

---

## âœ… æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œ

### å³åº§ã®è§£æ±ºï¼ˆæ‰‹å‹•æ›´æ–°ï¼‰
1. Firebase Consoleã§æ‰‹å‹•ã§è©•ä¾¡ã‚’æ›´æ–°
2. HOMEç”»é¢ã§è©•ä¾¡ãŒåæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### æ ¹æœ¬çš„ãªè§£æ±ºï¼ˆã‚³ãƒ¼ãƒ‰ã®ç¢ºèªï¼‰
1. é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
2. `updateParkRating`é–¢æ•°ã«ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ã€å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã€åŸå› ã‚’ç‰¹å®šã—ã¦ä¿®æ­£

### ä»Šå¾Œã®å¯¾å¿œ
- æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ã€è©•ä¾¡ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ã‹ç¢ºèª
- æ›´æ–°ã•ã‚Œãªã„å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦åŸå› ã‚’ç‰¹å®š

---

## ğŸ“ æ‰‹å‹•æ›´æ–°ã®æ‰‹é †ï¼ˆè©³ç´°ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: è©•ä¾¡ã‚’è¨ˆç®—
- ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: `1ä»¶`
- å¹³å‡è©•ä¾¡: `4.0`ï¼ˆ`rating: 4`ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒ1ä»¶ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—2: Firebase Consoleã§æ›´æ–°
1. **Firebase Consoleã‚’é–‹ã**
   - https://console.firebase.google.com/project/parkpedia-app/firestore/data
2. **`parks`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã**
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ `NR3aSxwvZyHnNZOtZ2PR` ã‚’é¸æŠ**
4. **`rating`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†**
   - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: `rating`
   - ã‚¿ã‚¤ãƒ—: `number`
   - å€¤: `4`
5. **`reviewCount`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†**
   - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: `reviewCount`
   - ã‚¿ã‚¤ãƒ—: `number`
   - å€¤: `1`
6. **ã€Œæ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯**

### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¢ãƒ—ãƒªã§ç¢ºèª
1. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•
2. HOMEç”»é¢ã§è©•ä¾¡ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. `4.0 (1ä»¶)` ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ç¢ºèª

`AddReviewScreen.js`ã®`updateParkRating`é–¢æ•°ã«ãƒ­ã‚°ã‚’è¿½åŠ ï¼š

```javascript
const updateParkRating = async (parkId) => {
  try {
    console.log('è©•ä¾¡æ›´æ–°é–‹å§‹:', parkId);
    
    // è©²å½“å…¬åœ’ã®ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
    const reviewsRef = collection(db, 'reviews');
    const q = query(reviewsRef, where('parkId', '==', parkId));
    const querySnapshot = await getDocs(q);
    
    console.log('ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°:', querySnapshot.size);
    
    // ... è©•ä¾¡è¨ˆç®— ...
    
    console.log('è©•ä¾¡æ›´æ–°å®Œäº†:', averageRating, reviewCount);
    
    // å…¬åœ’ã®è©•ä¾¡ã‚’æ›´æ–°
    const parkRef = doc(db, 'parks', parkId);
    await updateDoc(parkRef, {
      rating: Math.round(averageRating * 10) / 10,
      reviewCount: reviewCount,
    });
    
    console.log('Firestoreæ›´æ–°å®Œäº†');
  } catch (error) {
    console.error('è©•ä¾¡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦ã€å‘¼ã³å‡ºã—å…ƒã§å‡¦ç†
    throw error;
  }
};
```

ã“ã‚Œã§ã€ã©ã®æ®µéšã§å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã‹ç¢ºèªã§ãã¾ã™ã€‚

