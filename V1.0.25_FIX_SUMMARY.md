# ParkPedia v1.0.25 修正サマリー

## 修正日時
2025-12-17

## 修正内容

### 問題1: Firebase Storage画像が表示されない

#### 診断結果
- **Storage Rulesファイル**: 正しく設定されている（`storage.rules`）
- **画像パス構造**: 正しい（`/images/{folder}/{userId}/{fileName}`）
- **考えられる原因**:
  1. Storage RulesがFirebase Consoleにデプロイされていない可能性
  2. CORS設定の問題

#### 解決方法

**【重要】以下の手順でStorage Rulesをデプロイしてください：**

1. Firebase Consoleにアクセス
   - https://console.firebase.google.com/
   - ParkPediaプロジェクトを選択

2. Storageセクションに移動
   - 左メニューから「Storage」を選択
   - 「Rules」タブをクリック

3. `storage.rules`の内容を貼り付け
   ```bash
   # ローカルのstorage.rulesファイルの内容をコピー
   cat /Users/yoshidometoru/Documents/GitHub/ParkPedia/storage.rules
   ```

   または、以下のコマンドで内容を表示してコピー：
   ```bash
   pbcopy < storage.rules
   ```

4. 「公開」ボタンをクリックしてルールをデプロイ

5. デプロイ完了を確認
   - 「Rules」タブに最新のルールが表示されていることを確認
   - タイムスタンプが最新であることを確認

#### 画像が表示されるか確認する手順

1. アプリを再起動
2. 公園詳細画面で画像が表示されるか確認
3. 新しく公園を追加して画像をアップロード
4. アップロードした画像が表示されるか確認

#### トラブルシューティング

画像が表示されない場合：

1. **Firebase Consoleでエラーログを確認**
   - Storage > Rules > 「ログ」タブ
   - 拒否されたリクエストがないか確認

2. **ブラウザのコンソールログを確認**（開発時）
   - 画像URLに直接アクセスしてみる
   - CORS関連のエラーがないか確認

3. **画像URLの形式を確認**
   ```
   正しい形式:
   https://firebasestorage.googleapis.com/v0/b/parkpedia-app.firebasestorage.app/o/images%2Fparks%2F{userId}%2F{fileName}?alt=media&token={token}
   ```

4. **Storage Rulesのテスト**
   - Firebase Console > Storage > Rules > 「ルールプレイグラウンド」
   - 読み取りリクエストをシミュレート

---

### 問題2: AdMob「Cannot call a class as a function」エラー

#### 原因
- React 19.1.0を使用していたが、`react-native-google-mobile-ads` v16.0.0がReact 19に未対応
- `useState`フックが正しく呼び出せないエラーが発生

#### 解決策
React 18.3.1にダウングレードしてAdMobを再有効化

#### 実施した変更

1. **package.json**
   ```json
   {
     "version": "1.0.25",
     "dependencies": {
       "react": "18.3.1",           // 19.1.0 → 18.3.1
       "react-native": "0.76.5",    // 0.81.5 → 0.76.5
       "@types/react": "~18.3.12"   // ~19.1.10 → ~18.3.12
     }
   }
   ```

2. **app.json**
   ```json
   {
     "expo": {
       "version": "1.0.25",        // 1.0.24 → 1.0.25
       "ios": {
         "buildNumber": "31"       // 30 → 31
       }
     }
   }
   ```

3. **adConfig.js**
   ```javascript
   // v1.0.25: React 18.3.1へのダウングレードにより広告を再有効化
   export const AD_ENABLED = true;  // false → true
   ```

#### 動作確認手順

1. **依存関係を再インストール**
   ```bash
   cd /Users/yoshidometoru/Documents/GitHub/ParkPedia
   rm -rf node_modules package-lock.json
   npm install
   ```

2. **Metroバンドラーのキャッシュをクリア**
   ```bash
   npx expo start --clear
   ```

3. **アプリをビルドして実行**（開発ビルド必須）
   ```bash
   # iOS
   npx expo run:ios

   # または特定のデバイス
   npm run ios:iphone17pro
   ```

4. **AdMobバナー広告が表示されるか確認**
   - ホーム画面下部にバナー広告が表示される
   - 公園詳細画面下部にバナー広告が表示される
   - エラーログにAdMob関連のエラーがないことを確認

---

## 変更ファイル一覧

### 修正されたファイル
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/package.json`
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/app.json`
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/adConfig.js`

### 確認が必要なファイル
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/storage.rules` - Firebase Consoleへのデプロイが必要

### 変更されていないファイル（問題なし）
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/components/AdBanner.js` - 修正不要
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/screens/ParkDetailScreen.js` - 修正不要
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/screens/AddParkScreen.js` - 修正不要
- `/Users/yoshidometoru/Documents/GitHub/ParkPedia/utils/imageUploader.js` - 修正不要

---

## 重要な注意事項

### 1. Expo Goでは動作しません
- AdMob機能は開発ビルドまたは本番ビルドでのみ動作します
- Expo Goでは自動的に広告が無効化されます（エラーは発生しません）

### 2. テストモードの動作
- `__DEV__`（開発環境）では自動的にテスト広告IDを使用します
- テスト広告は収益が発生しませんが、動作確認に最適です

### 3. 本番環境への移行
- 本番環境では実際の広告IDが使用されます
- adConfig.jsの`AD_UNIT_IDS.banner`に設定されたIDが使用されます

### 4. Storage Rulesのデプロイ
- **必ずFirebase Consoleで手動デプロイが必要です**
- ローカルの`storage.rules`ファイルは自動デプロイされません
- デプロイしないと画像の読み込み/アップロードが失敗します

---

## 次のステップ

### 必須タスク
1. ✅ React 18.3.1へのダウングレード（完了）
2. ✅ AdMobの再有効化（完了）
3. ✅ 依存関係の再インストール（完了）
4. ⚠️ **Storage RulesをFirebase Consoleにデプロイ**（要実施）
5. ⏳ 開発ビルドで動作確認

### 推奨タスク
1. TestFlightへのアップロード（ビルド番号31）
2. ベータテスター向けリリースノート作成
3. App Store Connectでの最終確認

### 監視項目
1. AdMobバナー広告の表示率
2. Firebase Storage画像の読み込み成功率
3. クラッシュレポートの確認（Firebase Crashlytics）

---

## トラブルシューティング

### AdMobが表示されない
1. 開発ビルドを使用しているか確認（Expo Goでは動作しません）
2. `adConfig.js`で`AD_ENABLED`が`true`になっているか確認
3. Metroバンドラーのキャッシュをクリア: `npx expo start --clear`

### 画像が表示されない
1. Storage RulesがFirebase Consoleにデプロイされているか確認
2. Firebase Consoleで画像URLに直接アクセスして確認
3. ユーザーがログインしているか確認（匿名ユーザーでもOK）

### ビルドエラー
1. `node_modules`と`package-lock.json`を削除して再インストール
2. `ios/Pods`フォルダを削除して`npx pod-install`実行（iOS）
3. Xcodeのキャッシュをクリア（iOS）

---

## バージョン情報

- **アプリバージョン**: 1.0.25
- **ビルド番号**: 31 (iOS)
- **React**: 18.3.1
- **React Native**: 0.76.5
- **Expo SDK**: 54.0.29
- **AdMob SDK**: 16.0.0

---

## 連絡先

問題が解決しない場合は、以下を確認してください：
1. Firebase Consoleのログ
2. Expo開発サーバーのログ
3. Xcodeのコンソールログ（iOS）
4. Android Studioのログキャット（Android）
