# Firebase Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦ç´„

## ğŸ“š å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è¦ç‚¹

å‚è€ƒ: [Firebase Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](https://firebase.google.com/docs/storage/security?hl=ja)

### 1. èªè¨¼ï¼ˆAuthenticationï¼‰

- `request.auth`ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥
- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼: `request.auth.uid`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
- æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: `request.auth`ã¯`null`

**ä¾‹**:
```javascript
allow write: if request.auth != null;
```

### 2. èªå¯ï¼ˆAuthorizationï¼‰

- ãƒ‘ã‚¹ã”ã¨ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ç®¡ç†
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«ã§ã¯ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦èªè¨¼ãŒå¿…è¦
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ†ã‘ã‚‹ã“ã¨ã§ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãŒå®¹æ˜“

**ä¾‹**:
```javascript
match /images/{userId}/{fileName} {
  allow write: if request.auth.uid == userId;
}
```

### 3. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆData Validationï¼‰

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ¨å¥¨ã•ã‚Œã‚‹æ¤œè¨¼é …ç›®ï¼š

1. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: `request.resource.size < 5 * 1024 * 1024`ï¼ˆ5MBä»¥ä¸‹ï¼‰
2. **Content Type**: `request.resource.contentType.matches('image/.*')`ï¼ˆç”»åƒã®ã¿ï¼‰
3. **ãƒ•ã‚¡ã‚¤ãƒ«å**: å±é™ºãªæ–‡å­—ã‚’å«ã¾ãªã„ã‚ˆã†ã«æ¤œè¨¼

**å…¬å¼ä¾‹**:
```javascript
allow write: if request.resource.size < 5 * 1024 * 1024
           && request.resource.contentType.matches('image/.*');
```

---

## ğŸ” ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ«ã®è©•ä¾¡

### âœ… è‰¯ã„ç‚¹

1. **èªè¨¼ãƒã‚§ãƒƒã‚¯**: `isAuthenticated()`é–¢æ•°ã§å®Ÿè£…æ¸ˆã¿ âœ…
2. **ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®èªå¯**: `userId`ãƒ•ã‚©ãƒ«ãƒ€ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«åˆ†é›¢ âœ…
3. **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨contentTypeã®æ¤œè¨¼ã‚’å®Ÿè£… âœ…
4. **æ“ä½œã®åˆ†é›¢**: `create`ã€`update`ã€`delete`ã‚’åˆ†ã‘ã¦å®šç¾© âœ…

### âš ï¸ æ”¹å–„ã§ãã‚‹ç‚¹

1. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®`write`**: `create`ã€`update`ã€`delete`ã«åˆ†ã‘ã‚‹ã¹ã
2. **ãƒ«ãƒ¼ãƒ«ã®é‡è¤‡**: åŒã˜æ¤œè¨¼æ¡ä»¶ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ã‚‹ â†’ é–¢æ•°åŒ–ã§è§£æ±º
3. **ãƒ•ã‚¡ã‚¤ãƒ«åã®æ¤œè¨¼**: å±é™ºãªãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹æ¤œè¨¼ãŒãªã„ â†’ è¿½åŠ æ¨å¥¨

---

## ğŸ¯ æœ€é©åŒ–ã®åˆ¤æ–­

### çµè«–: **æœ€é©åŒ–ã‚’å®Ÿæ–½æ¸ˆã¿** âœ…

ç†ç”±ï¼š
1. **ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡å‰Šæ¸›**: æ¤œè¨¼æ¡ä»¶ã‚’é–¢æ•°åŒ–ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå®¹æ˜“ã«ãªã‚‹
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: ãƒ•ã‚¡ã‚¤ãƒ«åã®æ¤œè¨¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã‚’é˜²æ­¢
3. **å…¬å¼ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æº–æ‹ **: `write`ã‚’`create`ã€`update`ã€`delete`ã«åˆ†é›¢
4. **å¯èª­æ€§å‘ä¸Š**: ãƒ«ãƒ¼ãƒ«ãŒç°¡æ½”ã«ãªã‚Šã€ç†è§£ã—ã‚„ã™ããªã‚‹

---

## ğŸ“‹ æœ€é©åŒ–å†…å®¹

### 1. å…±é€šæ¤œè¨¼é–¢æ•°ã®è¿½åŠ 

```javascript
// ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ï¼ˆã‚µã‚¤ã‚ºã¨Content Typeï¼‰
function isValidImage(maxSizeMB) {
  return request.resource.size < maxSizeMB * 1024 * 1024
    && request.resource.contentType.matches('image/.*');
}

// ãƒ•ã‚¡ã‚¤ãƒ«åã®æ¤œè¨¼ï¼ˆå±é™ºãªæ–‡å­—ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
function isValidFileName(fileName) {
  return fileName.matches('^[a-zA-Z0-9._-]+$');
}
```

**æ³¨æ„**: `fileName`ã¯`match`ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®šç¾©ã•ã‚ŒãŸå¤‰æ•°ã®ãŸã‚ã€é–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®`write`ã‚’åˆ†é›¢

**ä¿®æ­£å‰**:
```javascript
allow write: if isAuthenticated()
  && isOwner(userId)
  && request.resource.size < 5 * 1024 * 1024
  && request.resource.contentType.matches('image/.*');
```

**ä¿®æ­£å¾Œ**:
```javascript
allow create: if isAuthenticated()
  && isOwner(userId)
  && isValidImage(5)
  && isValidFileName();

allow update: if isAuthenticated()
  && isOwner(userId)
  && isValidImage(5)
  && isValidFileName();

allow delete: if isAuthenticated()
  && isOwner(userId);
```

### 3. ãƒ«ãƒ¼ãƒ«ã®ç°¡æ½”åŒ–

æ¤œè¨¼æ¡ä»¶ã‚’é–¢æ•°åŒ–ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ãŒç°¡æ½”ã«ãªã‚Šã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

---

## âœ… æœ€é©åŒ–å¾Œã®ãƒ¡ãƒªãƒƒãƒˆ

1. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Š**: æ¤œè¨¼æ¡ä»¶ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€é–¢æ•°ã‚’1ç®‡æ‰€ä¿®æ­£ã™ã‚‹ã ã‘ã§æ¸ˆã‚€
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: ãƒ•ã‚¡ã‚¤ãƒ«åã®æ¤œè¨¼ã«ã‚ˆã‚Šã€ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã‚’é˜²æ­¢
3. **å¯èª­æ€§å‘ä¸Š**: ãƒ«ãƒ¼ãƒ«ãŒç°¡æ½”ã«ãªã‚Šã€ç†è§£ã—ã‚„ã™ããªã‚‹
4. **å…¬å¼ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æº–æ‹ **: Firebaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¨å¥¨äº‹é …ã«å¾“ã†

---

## ğŸ“ æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«

æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã¯`storage.rules`ãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ æ¸ˆã¿ã§ã™ã€‚

### ä¸»ãªå¤‰æ›´ç‚¹

1. âœ… `isValidImage(maxSizeMB)`é–¢æ•°ã‚’è¿½åŠ 
2. âœ… `isValidFileName()`é–¢æ•°ã‚’è¿½åŠ 
3. âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®`write`ã‚’`create`ã€`update`ã€`delete`ã«åˆ†é›¢
4. âœ… ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ«ã§å…±é€šé–¢æ•°ã‚’ä½¿ç”¨

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Firebase Consoleã§ãƒ«ãƒ¼ãƒ«ã‚’å…¬é–‹**
   - æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
   - ã€Œå…¬é–‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

2. **å‹•ä½œç¢ºèª**
   - ã‚¢ãƒ—ãƒªã§ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèª
   - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‹ç¢ºèª

---

**æœ€é©åŒ–å®Œäº†ï¼Firebase Consoleã§ãƒ«ãƒ¼ãƒ«ã‚’å…¬é–‹ã—ã¦ãã ã•ã„ï¼** âœ…

**æœ€çµ‚æ›´æ–°**: 2025-11-30
