# CLAUDE.md ã«è¿½åŠ ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆç”¨ï¼‰

ä»¥ä¸‹ã®å†…å®¹ã‚’`CLAUDE.md`ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

---

## ğŸš¨ éå»ã®ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºäº‹ä¾‹

### ã‚¨ãƒ©ãƒ¼äº‹ä¾‹1: Firebase Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®æœŸé™åˆ‡ã‚Œè­¦å‘Š

**ç™ºç”Ÿæ—¥**: 2025å¹´11æœˆ30æ—¥

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
```
[Firebase] Cloud Storage for Firebase ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã¨ 0 æ—¥ã§å¤±åŠ¹ã—ã¾ã™

ãŠå®¢æ§˜ã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§é–‹ç™ºã‚’é–‹å§‹ã—ãŸãŸã‚ã€Cloud Storage ãƒã‚±ãƒƒãƒˆãŒå®Œå…¨ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã•ã‚ŒãŸçŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚ŠãŠå®¢æ§˜ã®ã‚¢ãƒ—ãƒªã¯æ”»æ’ƒã«å¯¾ã—ã¦è„†å¼±ã«ãªã£ã¦ã„ãŸãŸã‚ã€æœ€åˆã® 30 æ—¥é–“ãŒéãã‚‹ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¨±å¯ã•ã‚Œãªããªã‚‹ã‚ˆã†ã« Cloud Storage ã® Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒæ§‹æˆã•ã‚Œã¾ã—ãŸã€‚

0 æ—¥å¾Œã«ã€Cloud Storage ãƒã‚±ãƒƒãƒˆã«å¯¾ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã™ã¹ã¦æ‹’å¦ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ãƒ«ãƒ¼ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã¾ã§å¼•ãç¶šãæ‹’å¦ã•ã‚Œã¾ã™ã€‚
```

**åŸå› **:
- Firebase Storageã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨å…¬é–‹ï¼‰ã®ã¾ã¾
- 30æ—¥é–“ã®çŒ¶äºˆæœŸé–“ãŒçµ‚äº†ã—ã€ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã‚‹çŠ¶æ…‹

**è§£æ±ºæ–¹æ³•**:
1. `storage.rules`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
2. é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè£…ï¼š
   - èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘ï¼ˆ`/images/parks/{userId}/`ãªã©ï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆå…¬åœ’ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ: 10MBã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ: 5MBï¼‰
   - Content Typeæ¤œè¨¼ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«åæ¤œè¨¼ï¼ˆå±é™ºãªæ–‡å­—ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
3. Firebase Console > Storage > ãƒ«ãƒ¼ãƒ«ã§å…¬é–‹

**æœ€é©åŒ–å†…å®¹**:
- å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆhttps://firebase.google.com/docs/storage/security?hl=jaï¼‰ã«åŸºã¥ã„ã¦æœ€é©åŒ–
- å…±é€šæ¤œè¨¼é–¢æ•°ã‚’è¿½åŠ ï¼ˆ`isValidImage()`, `isValidFileName()`ï¼‰
- `write`ã‚’`create`ã€`update`ã€`delete`ã«åˆ†é›¢

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«**: `storage.rules`, `FIREBASE_STORAGE_RULES_GUIDE.md`

---

### ã‚¨ãƒ©ãƒ¼äº‹ä¾‹2: Firestore æ¨©é™ã‚¨ãƒ©ãƒ¼

**ç™ºç”Ÿæ—¥**: 2025å¹´11æœˆ30æ—¥

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¢ãƒ—ãƒªå†…ï¼‰**:
```
æ¨©é™ã‚¨ãƒ©ãƒ¼
ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```

**åŸå› **:
- `favorites`ã¨`blockedUsers`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã€`allow read`ã‚’ä½¿ç”¨ã—ã¦ã„ãŸ
- ã‚¯ã‚¨ãƒªï¼ˆ`list`ï¼‰æ™‚ã«`resource.data`ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**è§£æ±ºæ–¹æ³•**:
1. `allow read`ã‚’`allow get`ã¨`allow list`ã«åˆ†é›¢
2. `get`: å€‹åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—ï¼ˆ`resource.data`ã‚’ä½¿ç”¨å¯èƒ½ï¼‰
3. `list`: ã‚¯ã‚¨ãƒªã§ã®ãƒªã‚¹ãƒˆå–å¾—ï¼ˆ`resource.data`ã¯ä½¿ç”¨ä¸å¯ã€ã‚¯ã‚¨ãƒªã®åˆ¶é™ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼‰

**ä¿®æ­£å‰**:
```javascript
match /favorites/{favoriteId} {
  allow read: if isAuthenticated()
    && resource.data.userId == request.auth.uid;
}
```

**ä¿®æ­£å¾Œ**:
```javascript
match /favorites/{favoriteId} {
  // Get: å€‹åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—
  allow get: if isAuthenticated()
    && resource.data.userId == request.auth.uid;

  // List: ã‚¯ã‚¨ãƒªã§ã®ãƒªã‚¹ãƒˆå–å¾—
  allow list: if isAuthenticated()
    && request.query.limit <= 100;
}
```

**é‡è¦ãªæ³¨æ„ç‚¹**:
- ã‚¢ãƒ—ãƒªå´ã®ã‚¯ã‚¨ãƒªã«`where('userId', '==', currentUser.uid)`ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹
- `list`ãƒ«ãƒ¼ãƒ«ã§ã¯ã€ã‚¯ã‚¨ãƒªã®åˆ¶é™ï¼ˆ`limit`ï¼‰ã®ã¿ãƒã‚§ãƒƒã‚¯å¯èƒ½

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«**: `firestore.rules`, `FIRESTORE_RULES_FIX_GUIDE.md`

---

## ğŸ“‹ Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. Firestore ãƒ«ãƒ¼ãƒ«

#### ã‚¯ã‚¨ãƒªã¨å€‹åˆ¥å–å¾—ã®åˆ†é›¢
```javascript
// âŒ é¿ã‘ã‚‹: ã‚¯ã‚¨ãƒªæ™‚ã«resource.dataã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
allow read: if resource.data.userId == request.auth.uid;

// âœ… æ¨å¥¨: getã¨listã‚’åˆ†é›¢
allow get: if resource.data.userId == request.auth.uid;
allow list: if request.query.limit <= 100;
```

#### ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æ¤œè¨¼
```javascript
// createdAtã¯ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ã‚’å¼·åˆ¶
function hasValidCreatedAt() {
  return request.resource.data.createdAt == request.time;
}

// updatedAtã‚‚ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ã‚’å¼·åˆ¶
function hasValidUpdatedAt() {
  return request.resource.data.updatedAt == request.time;
}
```

#### ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```javascript
// å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
&& request.resource.data.keys().hasAll(['name', 'address', 'userId', 'createdAt'])

// æ–‡å­—åˆ—ã®é•·ã•åˆ¶é™
&& request.resource.data.name.size() <= 100
```

### 2. Storage ãƒ«ãƒ¼ãƒ«

#### ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®èªå¯
```javascript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘
match /images/parks/{userId}/{fileName} {
  allow create: if isAuthenticated()
    && isOwner(userId)  // è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿
    && isValidImage(10)
    && isValidFileName(fileName);
}
```

#### ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
```javascript
// ã‚µã‚¤ã‚ºåˆ¶é™
request.resource.size < 10 * 1024 * 1024  // 10MB

// Content Typeæ¤œè¨¼
request.resource.contentType.matches('image/.*')

// ãƒ•ã‚¡ã‚¤ãƒ«åæ¤œè¨¼ï¼ˆãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã‚’é˜²æ­¢ï¼‰
fileName.matches('^[a-zA-Z0-9._-]+$')
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Firebase ãƒ«ãƒ¼ãƒ«é–¢é€£ã®ã‚¨ãƒ©ãƒ¼

#### ã‚¨ãƒ©ãƒ¼: "æ¨©é™ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"

**ç¢ºèªäº‹é …**:
1. Firebase Consoleã§ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ãå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹
2. `allow read`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€`allow get`ã¨`allow list`ã«åˆ†é›¢ã™ã‚‹
3. ã‚¯ã‚¨ãƒªã«é©åˆ‡ãª`where`å¥ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹

**è§£æ±ºæ‰‹é †**:
1. `firestore.rules`ã‚’ç¢ºèª
2. `allow read`ã‚’`allow get`ã¨`allow list`ã«åˆ†é›¢
3. Firebase Consoleã§å…¬é–‹
4. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•

#### ã‚¨ãƒ©ãƒ¼: "Storage ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã¨ X æ—¥ã§å¤±åŠ¹ã—ã¾ã™"

**ç¢ºèªäº‹é …**:
1. `storage.rules`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹
2. Firebase Consoleã§ãƒ«ãƒ¼ãƒ«ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹

**è§£æ±ºæ‰‹é †**:
1. `storage.rules`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/ç¢ºèª
2. Firebase Console > Storage > ãƒ«ãƒ¼ãƒ«ã§å…¬é–‹
3. ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ãé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“ é–‹ç™ºæ™‚ã®æ³¨æ„äº‹é …

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å¤‰æ›´æ™‚

- ãƒ«ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ãŸã‚‰ã€å¿…ãšFirebase Consoleã§å…¬é–‹ã™ã‚‹
- ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦å‹•ä½œç¢ºèªã™ã‚‹
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€Firebase Consoleã®ãƒ«ãƒ¼ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ã§æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

### 2. ã‚¯ã‚¨ãƒªã®å®Ÿè£…æ™‚

- Firestoreã®ã‚¯ã‚¨ãƒªã«ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§è¨±å¯ã•ã‚ŒãŸæ¡ä»¶ã‚’å«ã‚ã‚‹
- `list`ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã‚¢ãƒ—ãƒªå´ã§`where`å¥ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹

### 3. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚

- Storageã®ãƒ‘ã‚¹æ§‹é€ ã‚’æ­£ã—ãä½¿ç”¨ã™ã‚‹ï¼ˆ`/images/parks/{userId}/{fileName}`ãªã©ï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨Content Typeã‚’ç¢ºèªã™ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«åã«å±é™ºãªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹

---

## ğŸ¯ ä»Šå¾Œã®å‚è€ƒ

### ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ç¢ºèªæ‰‹é †

1. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª**
   - ã‚¢ãƒ—ãƒªå†…ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   - Firebase Consoleã®é€šçŸ¥
   - ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°

2. **Firebase Consoleã§ç¢ºèª**
   - Firestore Database > ãƒ«ãƒ¼ãƒ«
   - Storage > ãƒ«ãƒ¼ãƒ«
   - æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

3. **ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª**
   - `firestore.rules`
   - `storage.rules`
   - æœ€æ–°ã®å†…å®¹ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹

4. **ã‚¢ãƒ—ãƒªå´ã®å®Ÿè£…ã‚’ç¢ºèª**
   - ã‚¯ã‚¨ãƒªã«é©åˆ‡ãªæ¡ä»¶ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
   - ãƒ‘ã‚¹æ§‹é€ ãŒæ­£ã—ã„ã‹
   - èªè¨¼çŠ¶æ…‹ãŒæ­£ã—ã„ã‹

---

**ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’`CLAUDE.md`ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚**



