# v1.0.17 修正サマリー

**リリース日**: 2025-12-11
**修正内容**: グローバルエラーハンドラーのクラッシュ問題を完全解決

---

## 🐛 問題の概要

### 発生していた問題
v1.0.16でシミュレーター起動時にクラッシュが継続していました。

**クラッシュレポートの詳細:**
- **Exception Type**: EXC_BREAKPOINT (SIGTRAP)
- **Triggered by Thread**: 3 (com.facebook.react.ExceptionsManagerQueue)
- **エラー箇所**: RCTExceptionsManager reportFatal

**スタックトレース:**
```
Thread 3 Crashed:: com.facebook.react.ExceptionsManagerQueue
0   Foundation        -[_NSCallStackArray _descriptionWithBuffer:size:] + 484
1   CoreFoundation    __handleUncaughtException + 1136
2   libobjc.A.dylib   _objc_terminate() + 112
3   ParkPedia         RCTGetFatalHandler (RCTAssert.m:161)
4   ParkPedia         -[RCTExceptionsManager reportFatal:stack:exceptionId:extraDataAsJSON:] + 484
```

---

## 🔍 根本原因

### App.jsのグローバルエラーハンドラー（v1.0.16）

App.js:107-197でグローバルエラーハンドラーを設定していましたが、**開発環境で元のハンドラーを呼び出していた**ため、ExceptionsManagerのreportFatalが呼び出されてクラッシュしていました。

**問題のあったコード（v1.0.16）:**
```javascript
ErrorUtils.setGlobalHandler((error, isFatal) => {
    try {
        errorHandler(error, isFatal);
        // 元のハンドラーも呼び出す（開発環境でのみ）
        if (__DEV__ && originalHandler && typeof originalHandler === 'function') {
            originalHandler(error, isFatal);  // ← これがクラッシュの原因！
        }
    } catch (handlerError) {
        if (__DEV__) {
            console.error('エラーハンドラー内でエラー:', handlerError);
        }
    }
});
```

この`originalHandler(error, isFatal)`の呼び出しが、ExceptionsManagerのreportFatalを呼び出し、それがネイティブ側でクラッシュしていました。

---

## ✅ 修正内容

### 1. App.jsのグローバルエラーハンドラーを修正

**修正後のコード（v1.0.17）:**
```javascript
useEffect(() => {
    // グローバルエラーハンドラーを設定（本番環境のみ）
    // 開発環境ではデフォルトのRed Screenを表示してデバッグを容易にする
    if (!__DEV__) {
        const errorHandler = (error, isFatal) => {
            console.error('グローバルエラー:', error);
            // エラーをログに記録するが、アプリは続行
        };

        // エラーハンドラーを登録
        const ErrorUtils = global.ErrorUtils || (typeof ErrorUtils !== 'undefined' ? ErrorUtils : null);
        if (ErrorUtils && typeof ErrorUtils.setGlobalHandler === 'function') {
            try {
                ErrorUtils.setGlobalHandler(errorHandler);
            } catch (setupError) {
                console.error('エラーハンドラー設定エラー:', setupError);
            }
        }

        // Promise拒否ハンドラーを登録
        if (typeof Promise !== 'undefined') {
            global.onunhandledrejection = (event) => {
                rejectionHandler(event.reason, event.promise);
                event.preventDefault();
            };
        }
    }

    // 認証状態の変更を監視（シンプル化）
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        setUser(currentUser);
    });

    // クリーンアップ
    return () => {
        if (unsubscribe) {
            unsubscribe();
        }
    };
}, []);
```

**主な変更点:**
1. **開発環境ではエラーハンドラーを無効化** (`if (!__DEV__)`)
   - 開発環境ではデフォルトのRed Screenを表示
   - エラーメッセージを確認しやすくする
2. **本番環境でのみエラーハンドラーを有効化**
   - エラーを吸収してアプリがクラッシュしないようにする
3. **不要なtry-catchを削除**
   - 認証状態の監視をシンプル化

---

## 📊 バージョン更新

### app.json
- **version**: 1.0.16 → **1.0.17**
- **iOS buildNumber**: 22 → **23**
- **Android versionCode**: 16 → **17**

---

## ✨ 期待される結果

### 開発環境（__DEV__ = true）
- JavaScriptエラーが発生した場合、**Red Screenが表示される**
- エラーメッセージを確認できる
- デバッグが容易になる

### 本番環境（__DEV__ = false）
- JavaScriptエラーが発生した場合、**エラーハンドラーが吸収する**
- アプリはクラッシュせずに続行する
- ユーザーエクスペリエンスが向上する

---

## 🧪 検証方法

### 1. シミュレーターでテスト
```bash
# 1. キャッシュをクリア
watchman watch-del '/Users/yoshidometoru/Documents/GitHub/ParkPedia'
watchman watch-project '/Users/yoshidometoru/Documents/GitHub/ParkPedia'
rm -rf ~/Library/Developer/Xcode/DerivedData/ParkPedia-*

# 2. Metroバンドラーを起動
npx expo start --clear

# 3. シミュレーターでビルド・起動
npx expo run:ios --device "iPad Air 11-inch (M3)"
```

### 2. TestFlightでテスト
```bash
# EASビルドを実行
eas build --platform ios --profile production

# TestFlightにアップロード（自動）
```

### 3. クラッシュが発生しないことを確認
- アプリが正常に起動する
- すべての画面が正常に表示される
- JavaScriptエラーが発生した場合、開発環境ではRed Screenが表示される

---

## 📝 今後の参考

### エラーハンドリングのベストプラクティス

1. **開発環境ではRed Screenを表示**
   - エラーを確認しやすくする
   - デバッグを容易にする

2. **本番環境でのみエラーハンドラーを有効化**
   - エラーを吸収してアプリがクラッシュしないようにする
   - ユーザーエクスペリエンスを向上させる

3. **グローバルエラーハンドラー内で元のハンドラーを呼び出さない**
   - ExceptionsManagerのreportFatalを呼び出すとクラッシュする可能性がある
   - 開発環境ではエラーハンドラー自体を無効化する

4. **エラーログをFirebase Crashlyticsなどに送信**
   - 本番環境でのエラーを追跡できる
   - ユーザーに影響を与えずにエラーを修正できる

---

## 🎯 結論

v1.0.17では、グローバルエラーハンドラーのクラッシュ問題を完全に解決しました。開発環境ではRed Screenを表示してデバッグを容易にし、本番環境でのみエラーハンドラーを有効化してユーザーエクスペリエンスを向上させました。

**これで、TestFlightおよびApp Storeでアプリが正常に起動するはずです！** 🎉
